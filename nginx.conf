# Copyright 2017 the original author or authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http:#www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

worker_processes 5;

events {}

http {
  server {
    server_name m40.io;
    listen 80 default_server;
    root /usr/share/nginx/html;

    location /healthz {
      if ($http_x_forwarded_for = "") {
        add_header Content-Type text/plain;
        return 200 'ok';
      }
      return 404;
    }

    if ($arg_go-get = "1") {
      # This is a go-get operation.
      # Send any file in any repo to static content.
      rewrite ^/([^/]*)(/.*)?$  /_golang-go-get/$1.html;
    }

    location /_golang-go-get {
      # Serve static content.
      alias /usr/share/nginx/html/www/golang;
    }

    location / {
      # Any request that did not originally come in to the ELB
      # over HTTPS gets redirected.
      if ($http_x_forwarded_proto != "https") {
        rewrite ^(.*)$ https://$server_name$1 permanent;
      }

      # Default to redirecting to the "real" site.
      return 301 http://www.toolazydogs.com$request_uri;
    }
  }
}
